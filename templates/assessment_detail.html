{% extends 'base.html' %}
{% load static %}
{% load range_tags %}
{% load assessment_filters %}
{% load assessment_tags %}

{% block title %}Assessment Details | AAA{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header text-center" style="background-color: var(--bc-maroon); color: var(--bc-gold);">
                    <h3>{{ assessment.title }}</h3>
                </div>
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <p>Course: {{ assessment.course }}</p>
                        <p>Due Date: {{ assessment.due_date|date:"m/d/Y" }} at {{ assessment.due_date|time:"H:i" }}</p>
                    </div>

                    {% if user.profile.role == 'professor' or user.profile.role == 'Professor' %}
                    <div class="mb-4">
                        <h4 class="border-bottom pb-2" style="color: var(--bc-maroon);">Team and Class Averages</h4>
                        <div class="table-responsive mt-3">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Metric</th>
                                        <th>Team Average</th>
                                        <th>Class Average</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Contribution</td>
                                        <td>{{ team_avg_contribution|default:"0" }}</td>
                                        <td>{{ class_avg_contribution|default:"0" }}</td>
                                    </tr>
                                    <tr>
                                        <td>Teamwork</td>
                                        <td>{{ team_avg_teamwork|default:"0" }}</td>
                                        <td>{{ class_avg_teamwork|default:"0" }}</td>
                                    </tr>
                                    <tr>
                                        <td>Communication</td>
                                        <td>{{ team_avg_communication|default:"0" }}</td>
                                        <td>{{ class_avg_communication|default:"0" }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Quick Evaluation</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex gap-3 flex-wrap align-items-end">
                                <div class="flex-grow-1">
                                    <label class="form-label">Select Team</label>
                                    <select class="form-select" id="teamSelect">
                                        <option value="">Choose team...</option>
                                        {% for team in teams %}
                                        <option value="{{ team.id }}">{{ team.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="flex-grow-1">
                                    <label class="form-label">Team Member</label>
                                    <select class="form-select" id="memberSelect">
                                        <option value="">Select team first...</option>
                                    </select>
                                </div>
                                <div style="width: 120px;">
                                    <label class="form-label">Score</label>
                                    <input type="number" class="form-control" id="scoreInput" min="0" max="10"
                                        step="0.1" placeholder="0.0">
                                </div>
                                <div>
                                    <button class="btn gold-btn" onclick="submitEvaluation()">
                                        Submit
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Student Submissions for this Assessment</h5>
                        </div>
                        <div class="card-body">
                            {% if teams %}
                                <div class="accordion" id="submissionsAccordion">
                                    {% for team in teams %}
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="heading{{ team.id }}">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                        data-bs-target="#collapse{{ team.id }}" aria-expanded="false" 
                                                        aria-controls="collapse{{ team.id }}">
                                                    {{ team.name }} ({{ all_submissions|get_item:team.id|length|default:"0" }} submissions)
                                                </button>
                                            </h2>
                                            <div id="collapse{{ team.id }}" class="accordion-collapse collapse" 
                                                 aria-labelledby="heading{{ team.id }}" data-bs-parent="#submissionsAccordion">
                                                <div class="accordion-body">
                                                    {% if all_submissions|get_item:team.id %}
                                                        <div class="table-responsive">
                                                            <table class="table table-striped">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Student</th>
                                                                        <th>Submission Date</th>
                                                                        <th>Contribution</th>
                                                                        <th>Teamwork</th>
                                                                        <th>Communication</th>
                                                                        <th>Actions</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {% for item in all_submissions|get_item:team.id %}
                                                                        <tr>
                                                                            <td>{{ item.student.get_full_name|default:item.student.username }}</td>
                                                                            <td>{% if item.submission.submitted_at %}{{ item.submission.submitted_at|date:"M d, Y" }}{% else %}No date{% endif %}</td>
                                                                            <td>{{ item.submission.contribution|floatformat:1 }}</td>
                                                                            <td>{{ item.submission.teamwork|floatformat:1 }}</td>
                                                                            <td>{{ item.submission.communication|floatformat:1 }}</td>
                                                                            <td>
                                                                                <a href="{% url 'view_student_submissions' assessment.id %}?student_id={{ item.student.id }}" 
                                                                                   class="btn btn-sm gold-btn">View Details</a>
                                                                            </td>
                                                                        </tr>
                                                                    {% endfor %}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    {% else %}
                                                        <div class="alert alert-warning">
                                                            No submissions from this team yet.
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    {% if all_submissions.no_team %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingNoTeam">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                    data-bs-target="#collapseNoTeam" aria-expanded="false" 
                                                    aria-controls="collapseNoTeam">
                                                Students Not in Teams ({{ all_submissions.no_team|length }} submissions)
                                            </button>
                                        </h2>
                                        <div id="collapseNoTeam" class="accordion-collapse collapse" 
                                             aria-labelledby="headingNoTeam" data-bs-parent="#submissionsAccordion">
                                            <div class="accordion-body">
                                                <div class="table-responsive">
                                                    <table class="table table-striped">
                                                        <thead>
                                                            <tr>
                                                                <th>Student</th>
                                                                <th>Submission Date</th>
                                                                <th>Contribution</th>
                                                                <th>Teamwork</th>
                                                                <th>Communication</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for item in all_submissions.no_team %}
                                                                <tr>
                                                                    <td>{{ item.student.get_full_name|default:item.student.username }}</td>
                                                                    <td>{% if item.submission.submitted_at %}{{ item.submission.submitted_at|date:"M d, Y" }}{% else %}No date{% endif %}</td>
                                                                    <td>{{ item.submission.contribution|floatformat:1 }}</td>
                                                                    <td>{{ item.submission.teamwork|floatformat:1 }}</td>
                                                                    <td>{{ item.submission.communication|floatformat:1 }}</td>
                                                                    <td>
                                                                        <a href="{% url 'view_student_submissions' assessment.id %}?student_id={{ item.student.id }}" 
                                                                           class="btn btn-sm gold-btn">View Details</a>
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    No teams found for this course.
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            // Get teams data from the backend
                            const teams = JSON.parse('{{ teams_json|escapejs }}');
                            
                            document.getElementById('teamSelect').addEventListener('change', function () {
                                const memberSelect = document.getElementById('memberSelect');
                                memberSelect.innerHTML = '<option value="">Select member...</option>';
                                
                                const teamId = this.value;
                                if (!teamId) return;
                                
                                // Find the selected team and its members
                                const selectedTeam = teams.find(team => team.id.toString() === teamId);
                                if (selectedTeam && selectedTeam.members) {
                                    selectedTeam.members.forEach(member => {
                                        memberSelect.add(new Option(member.name, member.id));
                                    });
                                }
                            });
                        });
                        
                        function submitEvaluation() {
                            const team = document.getElementById('teamSelect').value;
                            const member = document.getElementById('memberSelect').value;
                            const score = document.getElementById('scoreInput').value;
                            
                            if (!team || !member || !score) {
                                alert('Please fill in all fields');
                                return;
                            }
                            
                            // Send data to the backend using fetch API
                            fetch('{% url "submit_student_score" %}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: new URLSearchParams({
                                    'assessment_id': '{{ assessment.id }}',
                                    'student_id': member,
                                    'score': score
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert(data.message);
                                    // Optionally refresh the page or update UI
                                } else {
                                    throw new Error(data.error || 'Failed to submit score');
                                }
                            })
                            .catch(error => {
                                alert('Error: ' + error.message);
                            });
                        }
                    </script>
                    {% endif %}

                    {% if user.profile.role == 'student' or user.profile.role == 'Student' %}
                    <div id="studentView" class="container">
                        <h2>Peer Assessment</h2>
                        <form method="post" action="{% url 'submit_assessment' assessment.id %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="student" class="form-label">Select Team Member:</label>
                                <select id="student" name="student" class="form-select" required>
                                    {% for member in team_members %}
                                    <option value="{{ member.username }}">{{
                                        member.get_full_name|default:member.username }}</option>
                                    {% endfor %}
                                    <option value="{{ request.user.username }}">Self</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">Rate Contribution:</label>
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>Poor</span>
                                    <div class="d-flex align-items-center position-relative w-100 mx-3">
                                        <hr class="w-100 position-absolute" style="top: 50%; z-index: 0; border: 1px solid #ccc;">
                                        {% for i in 5|range_filter %}
                                        <div class="form-check mx-auto" style="z-index: 1;">
                                            {% if submission and submission.contribution == i %}
                                            <input class="form-check-input" type="radio" name="contribution" value="{{ i }}" checked required>
                                            {% else %}
                                            <input class="form-check-input" type="radio" name="contribution" value="{{ i }}" required>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <span>Excellent</span>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">Rate Teamwork:</label>
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>Poor</span>
                                    <div class="d-flex align-items-center position-relative w-100 mx-3">
                                        <hr class="w-100 position-absolute" style="top: 50%; z-index: 0; border: 1px solid #ccc;">
                                        {% for i in 5|range_filter %}
                                        <div class="form-check mx-auto" style="z-index: 1;">
                                            <input class="form-check-input" type="radio" name="teamwork" value="{{ i }}"
                                                {% if submission and submission.teamwork == i %}checked{% endif %} required>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <span>Excellent</span>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">Rate Communication:</label>
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>Poor</span>
                                    <div class="d-flex align-items-center position-relative w-100 mx-3">
                                        <hr class="w-100 position-absolute" style="top: 50%; z-index: 0; border: 1px solid #ccc;">
                                        {% for i in 5|range_filter %}
                                        <div class="form-check mx-auto" style="z-index: 1;">
                                            <input class="form-check-input" type="radio" name="communication" value="{{ i }}"
                                                {% if submission and submission.communication == i %}checked{% endif %} required>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <span>Excellent</span>
                                </div>
                            </div>

                            <!-- For Likert Scale Questions -->
                            {% for question in likert_questions %}
                            <div class="mb-4">
                                <label class="form-label">{{ question.question_text|safe }}</label>

                                {% if question.question_type == 'team' %}
                                <!-- Team question (overall) -->
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>Poor</span>
                                    <div class="d-flex align-items-center position-relative w-100 mx-3">
                                        <hr class="w-100 position-absolute"
                                            style="top: 50%; z-index: 0; border: 1px solid #ccc;">
                                        {% for i in 5|range_filter %}
                                        <div class="form-check mx-auto" style="z-index: 1;">
                                            <input class="form-check-input" type="radio" name="likert_{{ question.id }}"
                                                value="{{ i }}" {% has_response_with_rating submission question i as
                                                has_response %} {% if has_response %}checked{% endif %} required>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <span>Excellent</span>
                                </div>
                                {% else %}
                                <!-- Individual question (per teammate) -->
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6>Rate each team member individually:</h6>
                                    </div>
                                    <div class="card-body">
                                        {% for teammate in teammates %}
                                        {% if teammate.username != request.user.username %}
                                        <div class="mb-3">
                                            <label class="form-label">{{
                                                teammate.get_full_name|default:teammate.username }}</label>
                                            <div class="d-flex align-items-center justify-content-between">
                                                <span>Poor</span>
                                                <div class="d-flex align-items-center position-relative w-100 mx-3">
                                                    <hr class="w-100 position-absolute"
                                                        style="top: 50%; z-index: 0; border: 1px solid #ccc;">
                                                    {% for i in 5|range_filter %}
                                                    <div class="form-check mx-auto" style="z-index: 1;">
                                                        <input class="form-check-input" type="radio"
                                                            name="likert_{{ question.id }}_{{ teammate.id }}"
                                                            value="{{ i }}" 
                                                            {% has_response_with_rating_for_teammate submission question teammate i as has_response %} 
                                                            {% if has_response %}checked{% endif %} 
                                                            required>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                <span>Excellent</span>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}

                            <!-- For Open-Ended Questions -->
                            {% for question in open_ended_questions %}
                            <div class="mb-4">
                                <label class="form-label">{{ question.question_text|safe }}</label>

                                {% if question.question_type == 'team' %}
                                <!-- Team question (overall) -->
                                <textarea class="form-control" name="open_ended_{{ question.id }}" rows="4"
                                    required>{% if submission %}{% get_open_ended_response submission question as response %}{{ response }}{% endif %}</textarea>
                                {% else %}
                                <!-- Individual question (per teammate) -->
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6>Provide feedback for each team member individually:</h6>
                                    </div>
                                    <div class="card-body">
                                        {% for teammate in teammates %}
                                        {% if teammate.username != request.user.username %}
                                        <div class="mb-3">
                                            <label class="form-label">{{
                                                teammate.get_full_name|default:teammate.username }}</label>
                                            <textarea class="form-control"
                                                name="open_ended_{{ question.id }}_{{ teammate.id }}" rows="4"
                                                required>{% if submission %}{% get_open_ended_response_for_teammate submission question teammate as response %}{{ response }}{% endif %}</textarea>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}

                            <div class="mb-3">
                                <label for="feedback" class="form-label">Give an overview of this member's role in
                                    the team:</label>
                                <textarea id="feedback" name="feedback" class="form-control" rows="4"
                                    placeholder="Provide additional feedback here...">{% if submission %}{{ submission.feedback }}{% endif %}</textarea>
                            </div>

                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">Submit Assessment</button>
                            </div>
                        </form>

                        <div class="mt-4">
                            <h3>Summary Report</h3>
                            <p>Average Grade: <span id="averageGrade">N/A</span></p>
                            <h4>Comments:</h4>
                            <ul id="commentsList"></ul>
                        </div>
                    </div>
                    {% endif %}

                    {% if user.profile.role == 'professor' or user.profile.role == 'Professor' %}
                    <div class="mb-4">
                        <h4 class="border-bottom pb-2" style="color: var(--bc-maroon);">Professor Controls</h4>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h5>Assessment Management</h5>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Current Status:</strong> 
                                            {% if assessment.closed_date %}
                                                <span class="badge bg-danger">Closed</span>
                                            {% elif is_active %}
                                                <span class="badge bg-success">Active</span>
                                            {% else %}
                                                <span class="badge bg-warning">Not Yet Open</span>
                                            {% endif %}
                                        </p>
                                        
                                        {% if not assessment.closed_date %}
                                        <form method="post" action="{% url 'close_assessment' assessment.id %}">
                                            {% csrf_token %}
                                            <button type="submit" class="btn maroon-btn" onclick="return confirm('Are you sure you want to close this assessment? This will end all submissions.')">
                                                Close Assessment
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h5>View Submissions</h5>
                                    </div>
                                    <div class="card-body">
                                        <a href="{% url 'view_team_submissions' assessment.id %}" class="btn gold-btn mb-2">View by Team</a>
                                        <a href="{% url 'view_student_submissions' assessment.id %}" class="btn gold-btn">View by Student</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="professorView" class="container mt-4">
                        <div class="card shadow">
                            <div class="card-header" style="background-color: var(--bc-maroon); color: var(--bc-gold);">
                                <h4>Assessment Management</h4>
                                {% if not assessment.is_published and not is_active %}
                                <span class="badge bg-success">Draft - Questions Can Be Edited</span>
                                {% elif assessment.is_published %}
                                <span class="badge bg-danger">Published - Questions Cannot Be Modified</span>
                                {% elif is_active %}
                                <span class="badge bg-warning">Active - Questions Cannot Be Modified</span>
                                {% endif %}
                            </div>
                            <div class="card-body">
                                <!-- For published assessments scheduled for future release -->
                                {% if assessment.is_scheduled %}
                                <div class="alert alert-info mb-4">
                                    <h5>Assessment Status: Scheduled for Release</h5>
                                    <p>This assessment is published but not yet visible to students. It will be released
                                        on {{ assessment.release_date|date:"F d, Y" }} at {{
                                        assessment.release_date|time:"H:i" }}.</p>
                                    <form method="post" action="{% url 'publish_assessment_now' assessment.id %}"
                                        class="mt-2">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success"
                                            onclick="return confirm('Are you sure you want to publish this assessment now? This will make it immediately visible to students.')">
                                            <i class="fas fa-rocket me-2"></i>Publish Now
                                        </button>
                                    </form>
                                </div>
                                {% endif %}

                                <!-- For draft assessments with future release date -->
                                {% if not assessment.is_published and assessment.release_date and assessment.release_date > now %}
                                <div class="alert alert-info mb-4">
                                    <h5>Assessment Status: Draft with Future Release Date</h5>
                                    <p>This assessment will be released to students on {{
                                        assessment.release_date|date:"F d, Y" }} at {{
                                        assessment.release_date|time:"H:i" }} if published.</p>
                                    <form method="post" action="{% url 'publish_assessment_now' assessment.id %}"
                                        class="mt-2">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success"
                                            onclick="return confirm('Are you sure you want to publish this assessment now? This will make it immediately visible to students.')">
                                            <i class="fas fa-rocket me-2"></i>Publish Now
                                        </button>
                                    </form>
                                </div>
                                {% endif %}

                                <!-- For draft assessments without a release date -->
                                {% if not assessment.is_published and not assessment.release_date %}
                                <div class="alert alert-info mb-4">
                                    <h5>Assessment Status: Draft</h5>
                                    <p>This assessment is in draft mode and has no scheduled release date. You can
                                        publish it immediately to make it visible to students.</p>
                                    <form method="post" action="{% url 'publish_assessment_now' assessment.id %}"
                                        class="mt-2">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success"
                                            onclick="return confirm('Are you sure you want to publish this assessment now? This will make it immediately visible to students.')">
                                            <i class="fas fa-rocket me-2"></i>Publish Now
                                        </button>
                                    </form>
                                </div>
                                {% endif %}

                                {% if teams %}
                                <div class="mb-4">
                                    <h5>Student Responses by Team</h5>
                                    {% for team in teams %}
                                    <div class="card mb-3">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6>{{ team.name|default:"Unnamed Team" }}</h6>
                                        </div>
                                        <div class="card-body">
                                            {% for member in team.members.all %}
                                            <div class="student-response mb-3 p-3 border rounded">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h6>{{ member.get_full_name|default:member.username }}</h6>
                                                    <div class="score-input-group">
                                                        <input type="number"
                                                            class="form-control form-control-sm score-input me-2"
                                                            style="width: 100px;" min="0" max="10" step="0.1"
                                                            value="{{ member.student_score.score|default:'' }}"
                                                            data-student-id="{{ member.id }}"
                                                            data-team-id="{{ team.id }}"
                                                            data-assessment-id="{{ assessment.id }}">
                                                        <button class="btn btn-primary btn-sm submit-score">
                                                            Submit Score
                                                        </button>
                                                    </div>
                                                </div>

                                                {% with received_submissions=member.assessed_submissions.all %}
                                                {% if received_submissions %}
                                                <div class="submissions-received mt-3">
                                                    <h6>Feedback Received:</h6>
                                                    {% for submission in received_submissions %}
                                                    {% if submission.assessment == assessment %}
                                                    <div class="submission-detail mt-2 p-2 border rounded">
                                                        <p><strong>From:</strong>
                                                            Anonymous Team Member</p>
                                                        <ul class="list-unstyled">
                                                            <li>Contribution:
                                                                {{ submission.contribution }}/5
                                                            </li>
                                                            <li>Teamwork:
                                                                {{ submission.teamwork }}/5
                                                            </li>
                                                            <li>Communication:
                                                                {{ submission.communication }}/5
                                                            </li>
                                                        </ul>
                                                        {% if submission.feedback %}
                                                        <p><strong>Feedback:</strong>
                                                            {{ submission.feedback }}</p>
                                                        {% endif %}

                                                        {% if submission.likert_responses.exists %}
                                                        <div class="likert-responses">
                                                            <p>
                                                                <strong>Additional
                                                                    Ratings:</strong>
                                                            </p>
                                                            {% for response in submission.likert_responses.all %}
                                                            <p>{{ response.question.question_text }}:
                                                                {{ response.rating }}/5
                                                            </p>
                                                            {% endfor %}
                                                        </div>
                                                        {% endif %}

                                                        {% if submission.open_ended_responses.exists %}
                                                        <div class="open-ended-responses">
                                                            <p>
                                                                <strong>Additional
                                                                    Comments:</strong>
                                                            </p>
                                                            {% for response in submission.open_ended_responses.all %}
                                                            <p>
                                                                <em>{{ response.question.question_text }}</em><br>
                                                                {{ response.response_text }}
                                                            </p>
                                                            {% endfor %}
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    {% endif %}
                                                    {% endfor %}
                                                </div>
                                                {% else %}
                                                <p class="text-muted mt-2">No assessments
                                                    received yet</p>
                                                {% endif %}
                                                {% endwith %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <div class="alert alert-info">No teams found for this assessment</div>
                                {% endif %}

                                <script>
                                    document.addEventListener('DOMContentLoaded', function () {
                                        const csrfToken = '{{ csrf_token }}';

                                        document.querySelectorAll('.submit-score').forEach(button => {
                                            button.addEventListener('click', function () {
                                                const inputGroup = this.closest('.score-input-group');
                                                const input = inputGroup.querySelector('.score-input');
                                                const score = parseFloat(input.value);

                                                if (isNaN(score) || score < 0 || score > 10) {
                                                    alert('Please enter a valid score between 0 and 10');
                                                    return;
                                                }

                                                submitScore({
                                                    student_id: input.dataset.studentId,
                                                    assessment_id: input.dataset.assessmentId,
                                                    score: score
                                                });
                                            });
                                        });

                                        function submitScore(data) {
                                            fetch('{% url "submit_student_score" %}', {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/x-www-form-urlencoded',
                                                    'X-CSRFToken': csrfToken
                                                },
                                                body: new URLSearchParams(data)
                                            })
                                                .then(response => response.json())
                                                .then(data => {
                                                    if (data.success) {
                                                        alert(data.message);
                                                    } else {
                                                        throw new Error(data.error ||
                                                            'Failed to submit score');
                                                    }
                                                })
                                                .catch(error => {
                                                    alert('Error: ' + error.message);
                                                });
                                        }
                                    });
                                </script>

                                {% if not assessment.is_published and not is_active %}
                                <form method="post" action="{% url 'edit_assessment_questions' assessment.id %}">
                                    {% csrf_token %}

                                    <h5 class="mb-3">Likert Scale Questions</h5>
                                    <div id="likert-questions-container">
                                        {% for question in likert_questions %}
                                        <div class="mb-3 likert-question">
                                            <div class="input-group">
                                                <input type="hidden" name="likert_id_{{ forloop.counter }}"
                                                    value="{{ question.id }}">
                                                <input type="text" class="form-control"
                                                    name="likert_text_{{ forloop.counter }}"
                                                    value="{{ question.question_text }}" required>
                                                <input type="number" class="form-control"
                                                    name="likert_order_{{ forloop.counter }}"
                                                    value="{{ question.order }}" min="1" style="max-width: 100px;"
                                                    required>
                                                <button type="button"
                                                    class="btn btn-danger remove-question">Remove</button>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <button type="button" id="add-likert-question" class="btn mb-4"
                                        style="background-color: var(--bc-maroon); color: white;">
                                        <i class="fas fa-plus me-2"></i>Add Likert Question
                                    </button>

                                    <h5 class="mb-3">Open-Ended Questions</h5>
                                    <div id="open-ended-questions-container">
                                        {% for question in open_ended_questions %}
                                        <div class="mb-3 open-ended-question">
                                            <div class="input-group">
                                                <input type="hidden" name="open_ended_id_{{ forloop.counter }}"
                                                    value="{{ question.id }}">
                                                <input type="text" class="form-control"
                                                    name="open_ended_text_{{ forloop.counter }}"
                                                    value="{{ question.question_text }}" required>
                                                <input type="number" class="form-control"
                                                    name="open_ended_order_{{ forloop.counter }}"
                                                    value="{{ question.order }}" min="1" style="max-width: 100px;"
                                                    required>
                                                <button type="button"
                                                    class="btn btn-danger remove-question">Remove</button>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <button type="button" id="add-open-ended-question" class="btn mb-4"
                                        style="background-color: var(--bc-maroon); color: white;">
                                        <i class="fas fa-plus me-2"></i>Add Open-Ended Question
                                    </button>

                                    <input type="hidden" id="likert-count" name="likert_count"
                                        value="{{ likert_questions|length }}">
                                    <input type="hidden" id="open-ended-count" name="open_ended_count"
                                        value="{{ open_ended_questions|length }}">

                                    <div class="d-flex justify-content-between mt-4">
                                        <button type="submit" name="action" value="save" class="btn"
                                            style="background-color: var(--bc-maroon); color: var(--bc-gold);">
                                            Save Draft</button>
                                        <button type="submit" name="action" value="publish" class="btn btn-success">Save
                                            &
                                            Publish</button>
                                    </div>
                                </form>

                                <script>
                                    document.addEventListener('DOMContentLoaded', function () {
                                        let likertCount = Number('{{ likert_questions|length }}');
                                        let openEndedCount = Number('{{ open_ended_questions|length }}');


                                        // Add Likert question
                                        document.getElementById('add-likert-question').addEventListener('click',
                                            function () {
                                                likertCount++;
                                                const container = document.getElementById(
                                                    'likert-questions-container');
                                                const div = document.createElement('div');
                                                div.className = 'mb-3 likert-question';
                                                div.innerHTML = `
                                                    <div class="input-group">
                                                        <input type="hidden" name="likert_id_${likertCount}" value="new">
                                                        <input type="text" class="form-control" name="likert_text_${likertCount}" 
                                                               placeholder="Enter question text" required>
                                                        <input type="number" class="form-control" name="likert_order_${likertCount}" 
                                                               value="${likertCount}" min="1" style="max-width: 100px;" required>
                                                        <button type="button" class="btn btn-danger remove-question">Remove</button>
                                                    </div>
                                                `;
                                                container.appendChild(div);
                                                document.getElementById('likert-count').value = likertCount;
                                            });

                                        // Add Open-ended question
                                        document.getElementById('add-open-ended-question').addEventListener(
                                            'click',
                                            function () {
                                                openEndedCount++;
                                                const container = document.getElementById(
                                                    'open-ended-questions-container');
                                                const div = document.createElement('div');
                                                div.className = 'mb-3 open-ended-question';
                                                div.innerHTML = `
                                                    <div class="input-group">
                                                        <input type="hidden" name="open_ended_id_${openEndedCount}" value="new">
                                                        <input type="text" class="form-control" name="open_ended_text_${openEndedCount}" 
                                                               placeholder="Enter question text" required>
                                                        <input type="number" class="form-control" name="open_ended_order_${openEndedCount}" 
                                                               value="${openEndedCount}" min="1" style="max-width: 100px;" required>
                                                        <button type="button" class="btn btn-danger remove-question">Remove</button>
                                                    </div>
                                                `;
                                                container.appendChild(div);
                                                document.getElementById('open-ended-count').value =
                                                    openEndedCount;
                                            });

                                        // Remove question (delegated event)
                                        document.addEventListener('click', function (e) {
                                            if (e.target && e.target.classList.contains('remove-question')) {
                                                e.target.closest(
                                                    '.likert-question, .open-ended-question').remove();

                                                // Update counts
                                                const likertQuestions = document.querySelectorAll(
                                                    '.likert-question').length;
                                                const openEndedQuestions = document.querySelectorAll(
                                                    '.open-ended-question').length;
                                                document.getElementById('likert-count').value =
                                                    likertQuestions;
                                                document.getElementById('open-ended-count').value =
                                                    openEndedQuestions;
                                            }
                                        });
                                    });
                                </script>
                                {% else %}
                                <div class="alert alert-warning">
                                    {% if assessment.is_published %}
                                    This assessment has been published. Questions cannot be modified.
                                    {% elif is_active %}
                                    This assessment is currently active. Questions cannot be modified.
                                    {% endif %}
                                </div>
                                <div class="mt-3">
                                    <a href="{% url 'dashboard' %}" class="btn"
                                        style="background-color: var(--bc-maroon); color: var(--bc-gold);">Back
                                        to
                                        Dashboard</a>
                                </div>
                                {% endif %}

                                <!-- Add Delete Assessment button -->
                                <div class="mt-4 mb-4">
                                    <h5>Danger Zone</h5>
                                    <div class="card border-danger">
                                        <div class="card-body">
                                            <h6 class="card-title text-danger">Delete Assessment</h6>
                                            <p>This action cannot be undone. All data associated with this assessment
                                                will be permanently deleted.</p>
                                            <button type="button" class="btn btn-danger delete-assessment-btn">
                                                <i class="fas fa-trash-alt me-2"></i>Delete Assessment
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Assessment Confirmation Modal -->
<div class="modal fade" id="deleteAssessmentModal" tabindex="-1" aria-labelledby="deleteAssessmentModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteAssessmentModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this assessment?</p>
                <p class="text-danger"><strong>Warning:</strong> This action cannot be undone and will permanently
                    delete:</p>
                <ul>
                    <li>All assessment questions</li>
                    <li>All student submissions</li>
                    <li>All peer review data</li>
                    <li>All scores and comments</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteAssessmentForm" method="post" action="{% url 'delete_assessment' assessment.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Permanently</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Replace the onclick confirm with modal trigger
    document.addEventListener('DOMContentLoaded', function () {
        const deleteButton = document.querySelector('.delete-assessment-btn');
        if (deleteButton) {
            deleteButton.addEventListener('click', function (e) {
                e.preventDefault();
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteAssessmentModal'));
                deleteModal.show();
            });
        }
    });
</script>

{% endblock %}
