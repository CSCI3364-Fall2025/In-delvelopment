{% extends 'base.html' %}
{% load static %}
{% load range_tags %}
{% load assessment_filters %}
{% load assessment_tags %}

{% block title %}Assessment Details | AAA{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Add this message display section -->
    {% if messages %}
    <div class="messages-container" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 80%; max-width: 800px;">
        {% for message in messages %}
        <div class="alert {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'success' %}alert-success{% else %}alert-info{% endif %} alert-dismissible fade show" 
             style="border: 2px solid {% if message.tags == 'error' %}#721c24{% elif message.tags == 'success' %}#155724{% else %}#0c5460{% endif %}; 
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
                    font-weight: bold;
                    {% if message.tags == 'error' %}
                    background-color: #f8d7da; 
                    color: #721c24;
                    {% elif message.tags == 'success' %}
                    background-color: #d4edda; 
                    color: #155724;
                    {% else %}
                    background-color: #d1ecf1; 
                    color: #0c5460;
                    {% endif %}"
             role="alert">
            <i class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'success' %}fa-check-circle{% else %}fa-info-circle{% endif %} me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <!-- End of message display section -->
    
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header text-center" style="background-color: var(--bc-maroon); color: var(--bc-gold);">
                    <h3>{{ assessment.title }}</h3>
                </div>
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <p>Course: {{ assessment.course }}</p>
                        <p>Due Date: {{ assessment.due_date|date:"m/d/Y" }} at {{ assessment.due_date|time:"H:i" }}</p>
                    </div>

                    {% if user.profile.role == 'professor' or user.profile.role == 'Professor' %}
                    <div class="mb-4">
                        <h4 class="border-bottom pb-2" style="color: var(--bc-maroon);">Team and Class Averages</h4>
                        
                        <!-- Team selection dropdown -->
                        <div class="mb-3">
                            <form method="get" action="{% url 'view_assessment' assessment.id %}">
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        <label for="team_select" class="form-label">Select Team for Averages:</label>
                                    </div>
                                    <div class="col-md-6">
                                        <select name="team_id" id="team_select" class="form-select">
                                            <option value="">All Teams (Class Average)</option>
                                            {% for team_item in teams %}
                                                <option value="{{ team_item.id }}" {% if selected_team and selected_team.id == team_item.id %}selected{% endif %}>
                                                    {{ team_item.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="submit" class="btn gold-btn">Apply</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <div class="table-responsive mt-3">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Metric</th>
                                        <th>Team Average</th>
                                        <th>Class Average</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Contribution</td>
                                        <td>{{ team_avg.contribution|floatformat:1 }}</td>
                                        <td>{{ class_avg.contribution|floatformat:1 }}</td>
                                    </tr>
                                    <tr>
                                        <td>Teamwork</td>
                                        <td>{{ team_avg.teamwork|floatformat:1 }}</td>
                                        <td>{{ class_avg.teamwork|floatformat:1 }}</td>
                                    </tr>
                                    <tr>
                                        <td>Communication</td>
                                        <td>{{ team_avg.communication|floatformat:1 }}</td>
                                        <td>{{ class_avg.communication|floatformat:1 }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Professor view of all submissions -->
                    <div class="mb-4">
                        <h4 class="border-bottom pb-2" style="color: var(--bc-maroon);">All Submissions</h4>
                        
                        {% if teams %}
                            <div class="accordion" id="teamsAccordion">
                                {% for team in teams %}
                                    <div class="accordion-item mb-3 border">
                                        <h2 class="accordion-header" id="heading{{ team.id }}">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                    data-bs-target="#collapse{{ team.id }}" aria-expanded="false" 
                                                    aria-controls="collapse{{ team.id }}">
                                                {{ team.name|default:"Team "|add:team.id|stringformat:"s" }}
                                                {% with team_submissions=all_submissions|get_item:team.id %}
                                                    ({{ team_submissions|length }} submissions)
                                                {% endwith %}
                                            </button>
                                        </h2>
                                        <div id="collapse{{ team.id }}" class="accordion-collapse collapse" 
                                             aria-labelledby="heading{{ team.id }}" data-bs-parent="#teamsAccordion">
                                            <div class="accordion-body">
                                                {% with team_submissions=all_submissions|get_item:team.id %}
                                                    {% if team_submissions %}
                                                        <div class="table-responsive">
                                                            <table class="table table-striped">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Student</th>
                                                                        <th>Submission Date</th>
                                                                        <th>Contribution</th>
                                                                        <th>Teamwork</th>
                                                                        <th>Communication</th>
                                                                        <th>Actions</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {% for item in team_submissions %}
                                                                        <tr>
                                                                            <td>{{ item.student.get_full_name|default:item.student.username }}</td>
                                                                            <td>{% if item.submission.submitted_at %}{{ item.submission.submitted_at|date:"M d, Y" }}{% else %}No date{% endif %}</td>
                                                                            <td>{{ item.submission.contribution|floatformat:1 }}</td>
                                                                            <td>{{ item.submission.teamwork|floatformat:1 }}</td>
                                                                            <td>{{ item.submission.communication|floatformat:1 }}</td>
                                                                            <td>
                                                                                <a href="{% url 'view_student_submissions' assessment.id %}?student_id={{ item.student.id }}" 
                                                                                   class="btn btn-sm gold-btn">View Details</a>
                                                                            </td>
                                                                        </tr>
                                                                    {% endfor %}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    {% else %}
                                                        <div class="alert alert-warning">
                                                            No submissions from this team yet.
                                                        </div>
                                                    {% endif %}
                                                {% endwith %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                                
                                {% if all_submissions.no_team %}
                                    <div class="accordion-item mb-3 border">
                                        <h2 class="accordion-header" id="headingNoTeam">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                    data-bs-target="#collapseNoTeam" aria-expanded="false" 
                                                    aria-controls="collapseNoTeam">
                                                Students Not in Teams ({{ all_submissions.no_team|length }} submissions)
                                            </button>
                                        </h2>
                                        <div id="collapseNoTeam" class="accordion-collapse collapse" 
                                             aria-labelledby="headingNoTeam" data-bs-parent="#teamsAccordion">
                                            <div class="accordion-body">
                                                <div class="table-responsive">
                                                    <table class="table table-striped">
                                                        <thead>
                                                            <tr>
                                                                <th>Student</th>
                                                                <th>Submission Date</th>
                                                                <th>Contribution</th>
                                                                <th>Teamwork</th>
                                                                <th>Communication</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for item in all_submissions.no_team %}
                                                                <tr>
                                                                    <td>{{ item.student.get_full_name|default:item.student.username }}</td>
                                                                    <td>{% if item.submission.submitted_at %}{{ item.submission.submitted_at|date:"M d, Y" }}{% else %}No date{% endif %}</td>
                                                                    <td>{{ item.submission.contribution|floatformat:1 }}</td>
                                                                    <td>{{ item.submission.teamwork|floatformat:1 }}</td>
                                                                    <td>{{ item.submission.communication|floatformat:1 }}</td>
                                                                    <td>
                                                                        <a href="{% url 'view_student_submissions' assessment.id %}?student_id={{ item.student.id }}" 
                                                                           class="btn btn-sm gold-btn">View Details</a>
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                No teams found for this course.
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if user.profile.role == 'student' or user.profile.role == 'Student' %}
                    <div id="studentView" class="container">
                        <h2>Peer Assessment</h2>
                        
                        <!-- Team Member Assessment Status -->
                        <div class="card mb-4 shadow">
                            <div class="card-header" style="background-color: var(--bc-maroon); color: var(--bc-gold);">
                                <h4>Team Assessment Progress</h4>
                            </div>
                            <div class="card-body">
                                <p class="mb-3">Please complete assessments for all team members, including yourself:</p>
                                
                                <div class="row">
                                    {% for member in team_members %}
                                    <div class="col-md-6 mb-3">
                                        <div class="team-member-card mb-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5 class="card-title">
                                                        {{ member.get_full_name|default:member.username }}
                                                        {% if member == request.user %}
                                                        <span class="badge bg-secondary">Self</span>
                                                        {% endif %}
                                                    </h5>
                                                    
                                                    {% with member_username=member.username %}
                                                    {% if member_username in user_submissions %}
                                                        <!-- Show submitted assessment details -->
                                                        <div class="submitted-assessment">
                                                            <span class="badge bg-success mb-2">Completed</span>
                                                            
                                                            <div class="assessment-details mt-2">
                                                                <div class="row">
                                                                    <div class="col-md-4">
                                                                        <p><strong>Contribution:</strong> {{ user_submissions|get_item:member_username|get_attr:"contribution" }}/5</p>
                                                                    </div>
                                                                    <div class="col-md-4">
                                                                        <p><strong>Teamwork:</strong> {{ user_submissions|get_item:member_username|get_attr:"teamwork" }}/5</p>
                                                                    </div>
                                                                    <div class="col-md-4">
                                                                        <p><strong>Communication:</strong> {{ user_submissions|get_item:member_username|get_attr:"communication" }}/5</p>
                                                                    </div>
                                                                </div>
                                                                
                                                                {% if user_submissions|get_item:member_username|get_attr:"feedback" %}
                                                                <div class="mt-2">
                                                                    <p><strong>Feedback:</strong> {{ user_submissions|get_item:member_username|get_attr:"feedback" }}</p>
                                                                </div>
                                                                {% endif %}
                                                                
                                                                <button class="btn btn-sm btn-outline-primary mt-2 edit-assessment-btn" 
                                                                        data-peer-id="{{ member.id }}" 
                                                                        data-peer-name="{{ member.get_full_name|default:member.username }}">
                                                                    Edit Assessment
                                                                </button>
                                                            </div>
                                                        </div>
                                                    {% else %}
                                                        <!-- Show not completed and assess button -->
                                                        <span class="badge bg-warning mb-2">Not Completed</span>
                                                        <div class="mt-2">
                                                            <a href="#" class="btn gold-btn assess-button" 
                                                               data-peer-id="{{ member.id }}" 
                                                               data-peer-name="{{ member.get_full_name|default:member.username }}">
                                                                {% if member == request.user %}
                                                                    Self Assessment
                                                                {% else %}
                                                                    Assess {{ member.get_full_name|default:member.username }}
                                                                {% endif %}
                                                            </a>
                                                        </div>
                                                    {% endif %}
                                                    {% endwith %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Assessment form structure -->
                        <form id="assessment-form" method="post" action="{% url 'submit_assessment' assessment.id %}" style="display: none;">
                            {% csrf_token %}
                            <input type="hidden" name="peer_id" value="">
                            
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">Assessing: <span id="assessed-peer-name"></span></h5>
                                </div>
                                <div class="card-body">
                                    <!-- Contribution Rating -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Contribution (1-5):</label>
                                        <div class="d-flex align-items-center">
                                            <input type="range" class="form-range me-3" name="contribution" min="1" max="5" step="1" value="3" id="contributionRange">
                                            <span class="badge bg-primary" id="contributionValue">3</span>
                                        </div>
                                        <small class="text-muted">Rate how much this person contributed to the team's work</small>
                                    </div>
                                    
                                    <!-- Teamwork Rating -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Teamwork (1-5):</label>
                                        <div class="d-flex align-items-center">
                                            <input type="range" class="form-range me-3" name="teamwork" min="1" max="5" step="1" value="3" id="teamworkRange">
                                            <span class="badge bg-primary" id="teamworkValue">3</span>
                                        </div>
                                        <small class="text-muted">Rate how well this person worked with the team</small>
                                    </div>
                                    
                                    <!-- Communication Rating -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Communication (1-5):</label>
                                        <div class="d-flex align-items-center">
                                            <input type="range" class="form-range me-3" name="communication" min="1" max="5" step="1" value="3" id="communicationRange">
                                            <span class="badge bg-primary" id="communicationValue">3</span>
                                        </div>
                                        <small class="text-muted">Rate how effectively this person communicated with the team</small>
                                    </div>
                                    
                                    <!-- Likert Questions -->
                                    {% if likert_questions %}
                                    <div class="mb-4">
                                        <h5 class="border-bottom pb-2">Additional Rating Questions</h5>
                                        {% for question in likert_questions %}
                                        <div class="mb-3">
                                            <label class="form-label">{{ question.question_text }}</label>
                                            <div class="d-flex align-items-center">
                                                <input type="range" class="form-range me-3" name="likert_{{ question.id }}" min="1" max="5" step="1" value="3" id="likert_{{ question.id }}_range">
                                                <span class="badge bg-primary" id="likert_{{ question.id }}_value">3</span>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Open-Ended Questions -->
                                    {% if open_ended_questions %}
                                    <div class="mb-4">
                                        <h5 class="border-bottom pb-2">Open-Ended Questions</h5>
                                        {% for question in open_ended_questions %}
                                        <div class="mb-3">
                                            <label for="openended_{{ question.id }}" class="form-label">{{ question.question_text }}</label>
                                            <textarea class="form-control" name="openended_{{ question.id }}" id="openended_{{ question.id }}" rows="3"></textarea>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Feedback -->
                                    <div class="mb-4">
                                        <label for="feedback" class="form-label fw-bold">Additional Feedback (Optional):</label>
                                        <textarea class="form-control" name="feedback" id="feedback" rows="3" placeholder="Provide constructive feedback for your teammate..."></textarea>
                                    </div>
                                    
                                    <!-- Submit Button -->
                                    <div class="text-end">
                                        <button type="submit" class="btn gold-btn">Submit Assessment</button>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <script>
                            // Update range value displays
                            document.addEventListener('DOMContentLoaded', function() {
                                // For standard ratings
                                document.getElementById('contributionRange').addEventListener('input', function() {
                                    document.getElementById('contributionValue').textContent = this.value;
                                });
                                
                                document.getElementById('teamworkRange').addEventListener('input', function() {
                                    document.getElementById('teamworkValue').textContent = this.value;
                                });
                                
                                document.getElementById('communicationRange').addEventListener('input', function() {
                                    document.getElementById('communicationValue').textContent = this.value;
                                });
                                
                                // For Likert questions
                                const likertRanges = document.querySelectorAll('input[id$="_range"]');
                                likertRanges.forEach(range => {
                                    range.addEventListener('input', function() {
                                        const valueId = this.id.replace('_range', '_value');
                                        document.getElementById(valueId).textContent = this.value;
                                    });
                                });
                                
                                // Add click handlers for all assess buttons
                                const assessButtons = document.querySelectorAll('.assess-button, .edit-assessment-btn');
                                assessButtons.forEach(button => {
                                    button.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        
                                        // Get the peer ID and name from data attributes
                                        const peerId = this.getAttribute('data-peer-id');
                                        const peerName = this.getAttribute('data-peer-name');
                                        
                                        // Set the peer ID in the hidden input field
                                        const peerIdInput = document.querySelector('input[name="peer_id"]');
                                        if (peerIdInput) {
                                            peerIdInput.value = peerId;
                                        }
                                        
                                        // Update any UI elements to show which peer is being assessed
                                        const peerNameElement = document.getElementById('assessed-peer-name');
                                        if (peerNameElement) {
                                            peerNameElement.textContent = peerName;
                                        }
                                        
                                        // If this is an edit button, pre-fill the form with existing data
                                        if (this.classList.contains('edit-assessment-btn')) {
                                            // Get the existing data from the DOM
                                            const contributionText = this.closest('.assessment-details').querySelector('p:contains("Contribution")').textContent;
                                            const teamworkText = this.closest('.assessment-details').querySelector('p:contains("Teamwork")').textContent;
                                            const communicationText = this.closest('.assessment-details').querySelector('p:contains("Communication")').textContent;
                                            const feedbackElement = this.closest('.assessment-details').querySelector('p:contains("Feedback")');
                                            
                                            // Extract the values
                                            const contributionValue = contributionText.match(/(\d+)\/5/)[1];
                                            const teamworkValue = teamworkText.match(/(\d+)\/5/)[1];
                                            const communicationValue = communicationText.match(/(\d+)\/5/)[1];
                                            const feedbackValue = feedbackElement ? feedbackElement.textContent.replace('Feedback:', '').trim() : '';
                                            
                                            // Set the form values
                                            document.getElementById('contributionRange').value = contributionValue;
                                            document.getElementById('contributionValue').textContent = contributionValue;
                                            
                                            document.getElementById('teamworkRange').value = teamworkValue;
                                            document.getElementById('teamworkValue').textContent = teamworkValue;
                                            
                                            document.getElementById('communicationRange').value = communicationValue;
                                            document.getElementById('communicationValue').textContent = communicationValue;
                                            
                                            if (document.getElementById('feedback')) {
                                                document.getElementById('feedback').value = feedbackValue;
                                            }
                                        }
                                        
                                        // Show the assessment form
                                        const assessmentForm = document.getElementById('assessment-form');
                                        if (assessmentForm) {
                                            assessmentForm.style.display = 'block';
                                            assessmentForm.scrollIntoView({ behavior: 'smooth' });
                                        }
                                    });
                                });
                            });
                        </script>
                    </div>
                    {% endif %}

                    {% if user.profile.role == 'professor' or user.profile.role == 'Professor' %}
                    <div id="professorView" class="container">
                        <div class="mb-4">
                            <h4 class="border-bottom pb-2" style="color: var(--bc-maroon);">Team and Class Averages</h4>
                            <div class="table-responsive mt-3">
                                <table class="table table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Metric</th>
                                            <th>Team Average</th>
                                            <th>Class Average</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Contribution</td>
                                            <td>{{ team_avg.contribution|floatformat:1 }}</td>
                                            <td>{{ class_avg.contribution|floatformat:1 }}</td>
                                        </tr>
                                        <tr>
                                            <td>Teamwork</td>
                                            <td>{{ team_avg.teamwork|floatformat:1 }}</td>
                                            <td>{{ class_avg.teamwork|floatformat:1 }}</td>
                                        </tr>
                                        <tr>
                                            <td>Communication</td>
                                            <td>{{ team_avg.communication|floatformat:1 }}</td>
                                            <td>{{ class_avg.communication|floatformat:1 }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Team Selection -->
                        <div class="card mb-4 shadow">
                            <div class="card-header" style="background-color: var(--bc-maroon); color: var(--bc-gold);">
                                <h4 class="mb-0">Team Submissions</h4>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="teamSelector" class="form-label">Select Team:</label>
                                    <select id="teamSelector" class="form-select" onchange="loadTeamData(this.value)">
                                        <option value="">Select a team...</option>
                                        {% for team in teams %}
                                        <option value="{{ team.id }}">{{ team.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div id="teamDataContainer" style="display: none;">
                                    <!-- Team Overview Card -->
                                    <div class="card mb-4">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">Team Overview</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6>Team Members:</h6>
                                                    <ul id="teamMembersList" class="list-group">
                                                        <!-- Team members will be populated here -->
                                                    </ul>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6>Submission Status:</h6>
                                                    <div class="progress mb-2">
                                                        <div id="submissionProgress" class="progress-bar" role="progressbar" style="width: 0%; background-color: var(--bc-maroon);" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                                    </div>
                                                    <small id="submissionStatus">0 of 0 members have completed all assessments</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Submission Matrix -->
                                    <div class="card mb-4">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">Peer Assessment Matrix</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-bordered">
                                                    <thead>
                                                        <tr>
                                                            <th>Evaluator ↓ / Evaluated →</th>
                                                            <th id="matrixHeaderRow">
                                                                <!-- Team member headers will be populated here -->
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="assessmentMatrix">
                                                        <!-- Matrix will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Student Selection -->
                                    <div class="card mb-4">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">View Individual Submissions</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="evaluatorSelector" class="form-label">Select Evaluator:</label>
                                                    <select id="evaluatorSelector" class="form-select" onchange="updateEvaluatedDropdown()">
                                                        <option value="">Select student...</option>
                                                        <!-- Options will be populated here -->
                                                    </select>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="evaluatedSelector" class="form-label">Select Student Being Evaluated:</label>
                                                    <select id="evaluatedSelector" class="form-select" disabled>
                                                        <option value="">Select evaluator first...</option>
                                                        <!-- Options will be populated here -->
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="d-grid">
                                                <button id="viewSubmissionBtn" class="btn" style="background-color: var(--bc-gold); color: var(--bc-maroon);" disabled onclick="viewSubmission()">
                                                    View Submission
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Submission Details (initially hidden) -->
                                    <div id="submissionDetails" class="card mb-4" style="display: none;">
                                        <div class="card-header bg-light">
                                            <h5 id="submissionTitle" class="mb-0">Submission Details</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="submissionContent">
                                                <!-- Submission details will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>
                        // Store team data globally
                        let teamsData = {{ teams_data|safe }};
                        let submissionsData = {};
                        
                        // Function to load team data when a team is selected
                        function loadTeamData(teamId) {
                            if (!teamId) {
                                document.getElementById('teamDataContainer').style.display = 'none';
                                return;
                            }
                            
                            document.getElementById('teamDataContainer').style.display = 'block';
                            
                            // Find the selected team
                            const selectedTeam = teamsData.find(team => team.id == teamId);
                            if (!selectedTeam) return;
                            
                            // Populate team members list
                            const teamMembersList = document.getElementById('teamMembersList');
                            teamMembersList.innerHTML = '';
                            
                            selectedTeam.members.forEach(member => {
                                const li = document.createElement('li');
                                li.className = 'list-group-item';
                                li.textContent = member.name;
                                teamMembersList.appendChild(li);
                            });
                            
                            // Populate evaluator dropdown
                            const evaluatorSelector = document.getElementById('evaluatorSelector');
                            evaluatorSelector.innerHTML = '<option value="">Select student...</option>';
                            
                            selectedTeam.members.forEach(member => {
                                const option = document.createElement('option');
                                option.value = member.id;
                                option.textContent = member.name;
                                evaluatorSelector.appendChild(option);
                            });
                            
                            // Reset other dropdowns and details
                            document.getElementById('evaluatedSelector').innerHTML = '<option value="">Select evaluator first...</option>';
                            document.getElementById('evaluatedSelector').disabled = true;
                            document.getElementById('viewSubmissionBtn').disabled = true;
                            document.getElementById('submissionDetails').style.display = 'none';
                            
                            // Fetch submission data for this team
                            fetchTeamSubmissions(teamId);
                        }
                        
                        // Function to fetch team submissions via AJAX
                        function fetchTeamSubmissions(teamId) {
                            fetch(`/api/team-submissions/${teamId}/{{ assessment.id }}/`)
                                .then(response => response.json())
                                .then(data => {
                                    submissionsData = data;
                                    updateSubmissionStatus(data);
                                    buildAssessmentMatrix(data);
                                })
                                .catch(error => {
                                    console.error('Error fetching team submissions:', error);
                                });
                        }
                        
                        // Update submission status and progress bar
                        function updateSubmissionStatus(data) {
                            const totalMembers = data.team_members.length;
                            const completedMembers = data.completed_members.length;
                            const percentage = totalMembers > 0 ? Math.round((completedMembers / totalMembers) * 100) : 0;
                            
                            document.getElementById('submissionProgress').style.width = `${percentage}%`;
                            document.getElementById('submissionProgress').setAttribute('aria-valuenow', percentage);
                            document.getElementById('submissionProgress').textContent = `${percentage}%`;
                            document.getElementById('submissionStatus').textContent = 
                                `${completedMembers} of ${totalMembers} members have completed all assessments`;
                        }
                        
                        // Build the assessment matrix
                        function buildAssessmentMatrix(data) {
                            const matrixHeaderRow = document.getElementById('matrixHeaderRow');
                            const assessmentMatrix = document.getElementById('assessmentMatrix');
                            
                            // Clear existing content
                            matrixHeaderRow.innerHTML = '';
                            assessmentMatrix.innerHTML = '';
                            
                            // Add headers for each team member
                            data.team_members.forEach(member => {
                                const th = document.createElement('th');
                                th.textContent = member.name;
                                matrixHeaderRow.appendChild(th);
                            });
                            
                            // Create a row for each evaluator
                            data.team_members.forEach(evaluator => {
                                const tr = document.createElement('tr');
                                
                                // Add evaluator name as first cell
                                const tdName = document.createElement('td');
                                tdName.textContent = evaluator.name;
                                tdName.className = 'fw-bold';
                                tr.appendChild(tdName);
                                
                                // Add cells for each evaluated member
                                data.team_members.forEach(evaluated => {
                                    const td = document.createElement('td');
                                    
                                    // Find submission if it exists
                                    const submission = data.submissions.find(s => 
                                        s.evaluator_id == evaluator.id && s.evaluated_id == evaluated.id);
                                    
                                    if (submission) {
                                        // Create a button to view the submission
                                        const btn = document.createElement('button');
                                        btn.className = 'btn btn-sm';
                                        btn.style.backgroundColor = 'var(--bc-gold)';
                                        btn.style.color = 'var(--bc-maroon)';
                                        btn.textContent = 'View';
                                        btn.onclick = function() {
                                            viewSpecificSubmission(evaluator.id, evaluated.id);
                                        };
                                        td.appendChild(btn);
                                    } else if (evaluator.id === evaluated.id) {
                                        // Self-assessment cell
                                        td.innerHTML = '<span class="text-muted">Self</span>';
                                    } else {
                                        // No submission
                                        td.innerHTML = '<span class="text-danger">Missing</span>';
                                    }
                                    
                                    tr.appendChild(td);
                                });
                                
                                assessmentMatrix.appendChild(tr);
                            });
                        }
                        
                        // Update the evaluated dropdown when an evaluator is selected
                        function updateEvaluatedDropdown() {
                            const evaluatorId = document.getElementById('evaluatorSelector').value;
                            const evaluatedSelector = document.getElementById('evaluatedSelector');
                            
                            if (!evaluatorId) {
                                evaluatedSelector.innerHTML = '<option value="">Select evaluator first...</option>';
                                evaluatedSelector.disabled = true;
                                document.getElementById('viewSubmissionBtn').disabled = true;
                                return;
                            }
                            
                            // Enable the dropdown
                            evaluatedSelector.disabled = false;
                            evaluatedSelector.innerHTML = '<option value="">Select student...</option>';
                            
                            // Get the selected team
                            const teamId = document.getElementById('teamSelector').value;
                            const selectedTeam = teamsData.find(team => team.id == teamId);
                            
                            // Add options for each team member except the evaluator
                            selectedTeam.members.forEach(member => {
                                if (member.id != evaluatorId) {  // Don't include self in the dropdown
                                    const option = document.createElement('option');
                                    option.value = member.id;
                                    option.textContent = member.name;
                                    evaluatedSelector.appendChild(option);
                                }
                            });
                            
                            // Disable the view button until an evaluated student is selected
                            document.getElementById('viewSubmissionBtn').disabled = true;
                        }
                        
                        // Enable the view button when both dropdowns have selections
                        document.getElementById('evaluatedSelector').addEventListener('change', function() {
                            document.getElementById('viewSubmissionBtn').disabled = !this.value;
                        });
                        
                        // View a specific submission
                        function viewSpecificSubmission(evaluatorId, evaluatedId) {
                            // Set the dropdown values
                            document.getElementById('evaluatorSelector').value = evaluatorId;
                            updateEvaluatedDropdown();
                            document.getElementById('evaluatedSelector').value = evaluatedId;
                            document.getElementById('viewSubmissionBtn').disabled = false;
                            
                            // View the submission
                            viewSubmission();
                        }
                        
                        // View the selected submission
                        function viewSubmission() {
                            const evaluatorId = document.getElementById('evaluatorSelector').value;
                            const evaluatedId = document.getElementById('evaluatedSelector').value;
                            
                            if (!evaluatorId || !evaluatedId) return;
                            
                            // Find the submission in the data
                            const submission = submissionsData.submissions.find(s => 
                                s.evaluator_id == evaluatorId && s.evaluated_id == evaluatedId);
                            
                            if (!submission) {
                                alert('No submission found for this combination.');
                                return;
                            }
                            
                            // Find the names
                            const evaluator = submissionsData.team_members.find(m => m.id == evaluatorId);
                            const evaluated = submissionsData.team_members.find(m => m.id == evaluatedId);
                            
                            // Update the submission title
                            document.getElementById('submissionTitle').textContent = 
                                `${evaluator.name}'s Assessment of ${evaluated.name}`;
                            
                            // Build the submission content
                            const content = document.getElementById('submissionContent');
                            content.innerHTML = `
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header bg-light">Contribution</div>
                                            <div class="card-body text-center">
                                                <h3>${submission.contribution}/5</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header bg-light">Teamwork</div>
                                            <div class="card-body text-center">
                                                <h3>${submission.teamwork}/5</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header bg-light">Communication</div>
                                            <div class="card-body text-center">
                                                <h3>${submission.communication}/5</h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card mb-4">
                                    <div class="card-header bg-light">Feedback</div>
                                    <div class="card-body">
                                        <p>${submission.feedback || 'No feedback provided.'}</p>
                                    </div>
                                </div>
                                
                                ${submission.likert_responses.length > 0 ? `
                                    <div class="card mb-4">
                                        <div class="card-header bg-light">Likert Responses</div>
                                        <div class="card-body">
                                            <ul class="list-group">
                                                ${submission.likert_responses.map(response => `
                                                    <li class="list-group-item">
                                                        <div class="fw-bold">${response.question_text}</div>
                                                        <div class="mt-2">Rating: ${response.rating}/5</div>
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${submission.open_ended_responses.length > 0 ? `
                                    <div class="card mb-4">
                                        <div class="card-header bg-light">Open-Ended Responses</div>
                                        <div class="card-body">
                                            <ul class="list-group">
                                                ${submission.open_ended_responses.map(response => `
                                                    <li class="list-group-item">
                                                        <div class="fw-bold">${response.question_text}</div>
                                                        <div class="mt-2">${response.response_text}</div>
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="text-muted">
                                    Submitted on ${new Date(submission.submitted_at).toLocaleString()}
                                </div>
                            `;
                            
                            // Show the submission details
                            document.getElementById('submissionDetails').style.display = 'block';
                            document.getElementById('submissionDetails').scrollIntoView({ behavior: 'smooth' });
                        }
                    </script>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Assessment Confirmation Modal -->
<div class="modal fade" id="deleteAssessmentModal" tabindex="-1" aria-labelledby="deleteAssessmentModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteAssessmentModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this assessment?</p>
                <p class="text-danger"><strong>Warning:</strong> This action cannot be undone and will permanently
                    delete:</p>
                <ul>
                    <li>All assessment questions</li>
                    <li>All student submissions</li>
                    <li>All peer review data</li>
                    <li>All scores and comments</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteAssessmentForm" method="post" action="{% url 'delete_assessment' assessment.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Permanently</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Replace the onclick confirm with modal trigger
    document.addEventListener('DOMContentLoaded', function () {
        const deleteButton = document.querySelector('.delete-assessment-btn');
        if (deleteButton) {
            deleteButton.addEventListener('click', function (e) {
                e.preventDefault();
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteAssessmentModal'));
                deleteModal.show();
            });
        }
    });
</script>

<!-- Add this script at the end of your template, just before the closing </body> tag -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add click handlers for all assess buttons
        const assessButtons = document.querySelectorAll('.assess-button, .edit-assessment-btn');
        assessButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Get the peer ID and name from data attributes
                const peerId = this.getAttribute('data-peer-id');
                const peerName = this.getAttribute('data-peer-name');
                
                // Set the peer ID in the hidden input field
                const peerIdInput = document.querySelector('input[name="peer_id"]');
                if (peerIdInput) {
                    peerIdInput.value = peerId;
                }
                
                // Update any UI elements to show which peer is being assessed
                const peerNameElement = document.getElementById('assessed-peer-name');
                if (peerNameElement) {
                    peerNameElement.textContent = peerName;
                }
                
                // If this is an edit button, pre-fill the form with existing data
                if (this.classList.contains('edit-assessment-btn')) {
                    // Get the existing data from the DOM
                    const contributionText = this.closest('.assessment-details').querySelector('p:contains("Contribution")').textContent;
                    const teamworkText = this.closest('.assessment-details').querySelector('p:contains("Teamwork")').textContent;
                    const communicationText = this.closest('.assessment-details').querySelector('p:contains("Communication")').textContent;
                    const feedbackElement = this.closest('.assessment-details').querySelector('p:contains("Feedback")');
                    
                    // Extract the values
                    const contributionValue = contributionText.match(/(\d+)\/5/)[1];
                    const teamworkValue = teamworkText.match(/(\d+)\/5/)[1];
                    const communicationValue = communicationText.match(/(\d+)\/5/)[1];
                    const feedbackValue = feedbackElement ? feedbackElement.textContent.replace('Feedback:', '').trim() : '';
                    
                    // Set the form values
                    document.getElementById('contributionRange').value = contributionValue;
                    document.getElementById('contributionValue').textContent = contributionValue;
                    
                    document.getElementById('teamworkRange').value = teamworkValue;
                    document.getElementById('teamworkValue').textContent = teamworkValue;
                    
                    document.getElementById('communicationRange').value = communicationValue;
                    document.getElementById('communicationValue').textContent = communicationValue;
                    
                    if (document.getElementById('feedback')) {
                        document.getElementById('feedback').value = feedbackValue;
                    }
                }
                
                // Show the assessment form
                const assessmentForm = document.getElementById('assessment-form');
                if (assessmentForm) {
                    assessmentForm.style.display = 'block';
                    assessmentForm.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });
        
        // Update range value displays
        document.getElementById('contributionRange').addEventListener('input', function() {
            document.getElementById('contributionValue').textContent = this.value;
        });
        
        document.getElementById('teamworkRange').addEventListener('input', function() {
            document.getElementById('teamworkValue').textContent = this.value;
        });
        
        document.getElementById('communicationRange').addEventListener('input', function() {
            document.getElementById('communicationValue').textContent = this.value;
        });
        
        // For Likert questions
        const likertRanges = document.querySelectorAll('input[id$="_range"]');
        likertRanges.forEach(range => {
            range.addEventListener('input', function() {
                const valueId = this.id.replace('_range', '_value');
                document.getElementById(valueId).textContent = this.value;
            });
        });
    });
</script>

{% endblock %}
