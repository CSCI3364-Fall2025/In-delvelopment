{% extends 'base.html' %}

{% block title %}Dashboard - {{ user.role }} | Peer Assessment System{% endblock %}

{% block content %}
<div class="container-fluid">
    {% if messages %}
    <div class="row mt-3">
        <div class="col">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if user.role|lower == 'student' and new_results %}
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        New assessment results have been published! <a href="{% url 'view_all_published_results' %}" class="alert-link">View Results</a>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <div class="row p-2" id="assessment-status-container">
        <div class="col-auto" id="status-header">
            <h2 style="color: var(--bc-maroon);">Status:</h2>
        </div>
        <div class="row" id="pending_assessments">
            <div class="col-auto">
                {% if num_uncompleted_assessments == 0 %}
                    <p>There are no active peer assessments.</p>
                {% else %}
                    <p>There are currently {{ num_uncompleted_assessments }} active assessment{% if num_uncompleted_assessments > 1 %}s{% endif %}.</p>
                {% endif %}
            </div>
            <div class="col-auto">
                {% if user.role == 'professor' or user.role == 'Professor' %}
                <a href="{% url 'course_dashboard' %}" style="color: var(--bc-gold);">Manage Courses and Teams</a>
                {% else %}
                <a href="#assessment-summary-container" style="color: var(--bc-gold);">View All Active Assessments</a>
                {% endif %}
            </div>
        </div>
        <div class="row" id="published_results">
            <div class="col-auto">
                {% if user.role == "professor" or user.role == "Professor" %}
                    {% if num_assessment_results == 0 %}
                        <p>You have no assessments results to return.</p>
                    {% else %}
                        <p>You have {{ num_assessment_results }} unreturned assessment{% if num_assessment_results > 1 %}s{% endif %} to grade.</p>
                    {% endif %}
                {% else %}
                    {% if num_published_results == 0 %}
                        <p>You have no assessment results to view.</p>
                    {% else %}
                        <p>You have {{ num_assessment_results }} returned assessment{% if num_assessment_results > 1 %}s{% endif %} to view.</p>
                    {% endif %}
                {% endif %}
            </div>
            <div class="col-auto">
                {% if user.role == "professor" or user.role == "Professor" %}
                <a href="#assessment-summary-container" style="color: var(--bc-gold);">Grade And Return Assessments</a>
                {% else %}
                <a href="{% url 'view_all_published_results' %}" style="color: var(--bc-gold);">View All Published
                    Results</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Enrolled Courses Table (for students) -->
    {% if user.profile.role == 'student' or request.session.user_role == 'student' %}
    <div class="row mt-4 mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header" style="background-color: var(--bc-maroon); color: var(--bc-gold);">
                    <h4 class="mb-0">My Enrolled Courses</h4>
                </div>
                <div class="card-body">
                    {% if active_courses %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Course Code</th>
                                    <th>Course Name</th>
                                    <th>Professor</th>
                                    <th>Teams</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for course in active_courses %}
                                <tr>
                                    <td>{{ course.course_code }}</td>
                                    <td>{{ course.name }}</td>
                                    <td>{{ course.created_by.get_full_name }}</td>
                                    <td>
                                        {% for team in user.teams.all %}
                                            {% if team.course == course %}
                                                {{ team.name }}{% if not forloop.last %}, {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <a href="{% url 'view_course' course_name=course.name %}" class="btn btn-sm gold-btn">View Course</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        You are not enrolled in any courses yet.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row justify-content-center" id="profile_box">
        <div class="w-75 border border-2 rounded p-1" style="border-color: var(--bc-maroon);">
            <div class="row p-1 text-center">
                <h1 style="color: var(--bc-maroon);">User Profile</h1>
            </div>
            <div class="row p-2 text-center justify-content-center">
                <div class="col-auto">
                    <h5>Name:</h5>
                </div>
                <div class="col-auto mb-0">
                    <h5 class="fw-lighter">{{ user.real_name }}</h5>
                </div>
            </div>
            <div class="row p-2 text-center justify-content-center">
                <div class="col-auto">
                    <h5>Preferred Name:</h5>
                </div>
                <div class="col-auto mb-0">
                    <h5 class="fw-lighter">{{ user.preferred_name }}</h5>
                </div>
            </div>
            <div class="row p-1 text-center justify-content-center">
                <div class="col-auto">
                    <h5>Email:</h5>
                </div>
                <div class="col-auto mb-0">
                    <h5 class="fw-lighter">{{ user.email }}</h5>
                </div>
            </div>
            <div class="row p-1 text-center justify-content-center">
                <div class="col-auto">
                    <h5>Role:</h5>
                </div>
                <div class="col-auto mb-0">
                    <h5 class="fw-lighter">{{ user.role }}</h5>
                </div>
            </div>
            <hr class="m-3">
            <div class="row p-1 text-center justify-content-center">
                <div class="col-auto">
                    <h5>Active Courses:</h5>
                </div>
                <div class="col-auto mb-0">
                    <h5 class="fw-lighter">
                        {% if not active_courses %}
                        <i>None</i>
                        {% else %}
                        {% for course in active_courses %}
                        {{ course.name }}{% if request.user == course.created_by %} <i>(Professor)</i>{% endif %};
                        {% endfor %}
                        {% endif %}
                    </h5>

                </div>
            </div>
            <div class="row p-1 text-center justify-content-center">
                <div class="col-auto">
                    <h5>My Teams:</h5>
                </div>
                <div class="col-auto mb-0">
                    <h5 class="fw-lighter">
                        {% if not active_teams %}
                        <i>None</i>
                        {% else %}
                        {% for team in active_teams %}
                        {% if team.name == "" %}
                        <i>(Unnamed team);</i>
                        {% else %}
                        {{ team.name }};
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                    </h5>
                </div>
            </div>
            <div class="row p-1 justify-content-center">
                <div class="col-auto justify-content-center">
                    <a class="btn gold-btn" href="{% url 'edit_profile' user.real_name %}">Edit Profile</a>
                </div>
            </div>
        </div>
    </div>

    <div class="row p-2" id="assessment-summary-container">
        <div class="row pt-1" id="assessments-summary-header">
            <h2 style="color: var(--bc-maroon);">Assessment Overview:</h2>
        </div>
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <h3>Active Assessments</h3>
            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Course</th>
                        <th>Due Date</th>
                        <th>Due Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for assessment in active_assessments %}
                    <tr>
                        <td>{{ assessment.id }}</td>
                        <td>{{ assessment.title }}</td>
                        <td>{{ assessment.course.name }}</td>
                        <td>{{ assessment.due_date|date:"Y-m-d" }}</td>
                        <td>{{ assessment.due_date|time:"H:i" }}</td>
                        <td>
                            <a href="{% url 'view_assessment' assessment.id %}" class="btn btn-sm" style="background-color: var(--bc-maroon); color: var(--bc-gold);">View Details</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">No active assessments</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <h3>Closed Assessments</h3>
            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Course</th>
                        <th>Closed Date</th>
                        <th>Closed Time</th>
                        <th>Grade</th>
                        <th>Comments</th>
                    </tr>
                </thead>
                <tbody>
                    {% for assessment in closed_assessments %}
                    <tr>
                        <td>{{ assessment.id }}</td>
                        <td>{{ assessment.title }}</td>
                        <td>{{ assessment.course }}</td>
                        <td>{{ assessment.closed_date|date:"M. d, Y" }}</td>
                        <td>{{ assessment.closed_date|time:"g:i a" }}</td>
                        <td>N/A</td>
                        <td>
                            <a href="{% url 'view_comments' assessment.id %}" class="btn maroon-btn">View Comments</a>
                        </td>
                    </tr>
                    {% empty %}
                        <tr>
                            <td colspan="7" class="text-center">No closed assessments</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-4">
            <h3>Upcoming Assessments</h3>
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th>Course</th>
                            <th>Open Date</th>
                            <th>Open Time</th>
                            {% if user.role == 'professor' %}
                            <th>Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for assessment in upcoming_assessments %}
                        <tr>
                            <td>{{ assessment.id }}</td>
                            <td>{{ assessment.title }}</td>
                            <td>{{ assessment.course.name }}</td>
                            <td>{{ assessment.open_date|date:"M. d, Y" }}</td>
                            <td>{{ assessment.open_date|time:"h:i a" }}</td>
                            {% if user.role == 'professor' %}
                            <td>
                                <a href="{% url 'view_assessment' assessment.id %}" class="btn btn-sm" style="background-color: var(--bc-maroon); color: var(--bc-gold);">View Details</a>
                            </td>
                            {% endif %}
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="{% if user.role == 'professor' %}6{% else %}5{% endif %}" class="text-center">No upcoming assessments</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="row p-2">
        <h2>{% if user.role == "professor" or user.role == "Professor" %}Professor{% else %}Student{% endif %} Tools:</h2>
    </div>
    {% if user.role == "professor" or user.role == "Professor" %}
    <div class="row p-2">
        <div class="col-auto">
            <a href="{% url 'create_course' %}" class="btn btn-lg maroon-btn">Create New Course</a>
        </div>
        <div class="col-auto">
            <a href="{% url 'create_peer_assessments' %}" class="btn btn-lg maroon-btn">Create New Assessment</a>
        </div>
        <div class="col-auto">
            <a href="{% url 'course_dashboard' %}" class="btn btn-lg maroon-btn">Manage Courses</a>
        </div>
        <div class="col-auto">
            <a href="{% url 'invite_students' %}" class="btn btn-lg maroon-btn">Invite Students</a>
        </div>
    </div>
    {% else %}
    <div class="row p-2">
        <div class="col-auto">
            <a href="{% url 'course_dashboard' %}" class="btn btn-lg gold-btn">View My Courses</a>
        </div>
        <div class="col-auto">
            <a href="#" class="btn btn-lg gold-btn">View My Teams</a>
        </div>
        <div class="col-auto">
            <a class="btn btn-lg gold-btn" href="{% url 'enroll_in_course' %}">Enroll in a Course</a>
        </div>
    </div>
    {% endif %}
    <hr>
    <div class="row p-2" id="quick_links">
        <div class="row">
            <div class="col-auto">
                <h5 style="color: var (--bc-maroon);">Quick Links:</h5>
            </div>
        </div>
        <div class="col-auto">
            <a href="{% url 'about' %}" style="color: var(--bc-gold);">About</a>
        </div>
        <div class="col-auto">
            <a href="#" style="color: var(--bc-gold);">Contact</a>
        </div>
        <div class="col-auto">
            <a href="#" style="color: var(--bc-gold);">Report an Issue</a>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h4>Debug Information</h4>
                </div>
                <div class="card-body">
                    <p>Profile Role: {{ user.profile.role|default:"Not set" }}</p>
                    <p>Session Role: {{ request.session.user_role|default:"Not set" }}</p>
                    <div class="mb-3">
                        <a href="{% url 'fix_session_role' %}" class="btn btn-sm btn-warning">Fix Session Role</a>
                        <a href="{% url 'debug_role' %}" class="btn btn-sm btn-info">View Detailed Debug Info</a>
                        <a href="{% url 'test_email' %}" class="btn btn-sm btn-primary">Test Email</a>
                        <a href="{% url 'create_test_data' %}" class="btn btn-sm btn-success">Create Test Assessment</a>
                    </div>
                    <div class="mb-3">
                        <p><strong>Set Role Directly:</strong></p>
                        <a href="{% url 'set_profile_role' role='student' %}"
                            class="btn btn-sm btn-outline-secondary">Set as Student</a>
                        <a href="{% url 'set_profile_role' role='professor' %}"
                            class="btn btn-sm btn-outline-primary">Set as Professor</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% if pending_invitations_count > 0 %}
    <div class="row mt-2">
        <div class="col-auto">
            <div class="alert alert-info">
                You have {{ pending_invitations_count }} pending course invitation(s).
                <a href="{% url 'pending_invitations' %}" class="alert-link">View and accept invitations</a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Pending Invitations Popup -->
{% if pending_invitations_count > 0 %}
<div class="modal fade" id="invitationsModal" tabindex="-1" aria-labelledby="invitationsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: var(--bc-maroon); color: var(--bc-gold);">
                <h5 class="modal-title" id="invitationsModalLabel">Pending Course Invitations</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>You have {{ pending_invitations_count }} pending course invitation(s).</p>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Course Code</th>
                                <th>Invited By</th>
                                <th>Invitation Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invitationsTableBody">
                            <!-- Will be populated via AJAX -->
                            <tr>
                                <td colspan="5" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="{% url 'pending_invitations' %}" class="btn gold-btn">View All Invitations</a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- JavaScript to handle the invitation popup -->
{% if pending_invitations_count > 0 %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Show the modal automatically when page loads
        var invitationsModal = new bootstrap.Modal(document.getElementById('invitationsModal'));
        invitationsModal.show();
        
        // Load invitations via AJAX
        fetch('{% url "get_pending_invitations_json" %}')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('invitationsTableBody');
                tableBody.innerHTML = '';
                
                data.invitations.forEach(invitation => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${invitation.course_name}</td>
                        <td>${invitation.course_code}</td>
                        <td>${invitation.invited_by}</td>
                        <td>${invitation.created_at}</td>
                        <td>
                            <form method="post" action="{% url 'accept_invitation' %}" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="invitation_id" value="${invitation.id}">
                                <input type="hidden" name="action" value="accept">
                                <button type="submit" class="btn btn-success btn-sm">Accept</button>
                            </form>
                            <form method="post" action="{% url 'accept_invitation' %}" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="invitation_id" value="${invitation.id}">
                                <input type="hidden" name="action" value="decline">
                                <button type="submit" class="btn btn-danger btn-sm">Decline</button>
                            </form>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error loading invitations:', error);
                document.getElementById('invitationsTableBody').innerHTML = 
                    '<tr><td colspan="5" class="text-danger">Error loading invitations. Please try again.</td></tr>';
            });
    });
</script>
{% endif %}
{% endblock %}