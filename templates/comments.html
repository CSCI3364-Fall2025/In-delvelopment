{% extends 'base.html' %}

{% block title %}Comments | Peer Assessment System{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header text-center" style="background-color: var(--bc-maroon); color: var(--bc-gold);">
                    <h3>{{ assessment.title }} - Comments</h3>
                </div>
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <p>Course: {{ assessment.course }}</p>
                        <p>Closed Date: {{ assessment.closed_date|date:"m/d/Y" }} at {{
                            assessment.closed_date|time:"H:i" }}</p>
                    </div>

                    <div class="mb-4">
                        <h4>Team and Class Averages</h4>
                        <table class="table table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>Metric</th>
                                    <th>Team Average</th>
                                    <th>Class Average</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Contribution</td>
                                    <td>{{ team_avg.contribution }}</td>
                                    <td>{{ class_avg.contribution }}</td>
                                </tr>
                                <tr>
                                    <td>Teamwork</td>
                                    <td>{{ team_avg.teamwork }}</td>
                                    <td>{{ class_avg.teamwork }}</td>
                                </tr>
                                <tr>
                                    <td>Communication</td>
                                    <td>{{ team_avg.communication }}</td>
                                    <td>{{ class_avg.communication }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mb-4">
                        <h4>General Commentary from the Team</h4>
                        <ul class="list-group">
                            {% for student, feedback in general_comments %}
                            <li class="list-group-item">
                                <strong>{{ student }}:</strong> {{ feedback }}
                            </li>
                            {% empty %}
                            <li class="list-group-item">No general comments available.</li>
                            {% endfor %}
                        </ul>
                    </div>

                    <div class="mb-4">
                        <h4>Additional Comments</h4>
                        <ul class="list-group">
                            {% for student, progress_notes in additional_comments %}
                            <li class="list-group-item">
                                <strong>{{ student }}:</strong> {{ progress_notes }}
                            </li>
                            {% empty %}
                            <li class="list-group-item">No additional comments available.</li>
                            {% endfor %}
                        </ul>
                    </div>

                    <!-- Professor-only publish results section -->
                    {% if user.profile.role == 'professor' or request.session.user_role == 'professor' %}
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h4>Publish Results</h4>
                        </div>
                        <div class="card-body">
                            {% if not assessment.results_published %}
                            <p>Ready to publish these results to students? This will send email notifications to all students who submitted this assessment.</p>
                            <a href="{% url 'publish_assessment_results' assessment.id %}" class="btn btn-success" 
                               onclick="return confirm('Are you sure you want to publish the results? This will notify all students.')">
                                <i class="fas fa-check-circle me-2"></i>Publish Results
                            </a>
                            {% else %}
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>Results published on {{ assessment.published_date|date:"m/d/Y" }} at {{ assessment.published_date|time:"H:i" }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <a href="{% url 'dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}